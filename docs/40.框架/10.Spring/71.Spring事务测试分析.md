---
title: Spring事务测试分析
date: 2022-09-08 23:30:37
permalink: /pages/77e282/
categories:
  - 框架
  - Spring
tags:
  - 
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
# Spring 事务测试分析

## 1. 前期准备

⭐ **pom 依赖**：Spring 核心、mysql、jdbc、数据库连接池

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>5.2.1.RELEASE</version>
    </dependency>
    <!-- mysql-->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>5.1.12</version>
    </dependency>
    <!-- Spring-jdbc 用于配置JdbcTemplate -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>5.0.9.RELEASE</version>
    </dependency>
    <!-- druid 数据库连接池-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.1.8</version>
    </dependency>
</dependencies>
```

⭐ **application.xml**：bean 配置、配置 mysql、事务

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:p="http://www.springframework.org/schema/p"
       xmlns:context="http://www.springframework.org/schema/context" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans
                           http://www.springframework.org/schema/beans/spring-beans.xsd
                           http://www.springframework.org/schema/aop
                           https://www.springframework.org/schema/aop/spring-aop.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">




    <bean class="com.zqc.service.MyService" id="myService">
        <property name="jdbcTemplate" ref="jdbcTemplate"/>
        <property name="myService" ref="myService"/>
    </bean>

    <!-- 配置mysql -->
    <bean id="dataSource"  class="com.alibaba.druid.pool.DruidDataSource" destroy-method="close">
        <property name="driverClassName" value="com.mysql.jdbc.Driver"/>
        <property name="url" value="xxx"/>
        <property name="username" value="账号"/>
        <property name="password" value="密码"/>
    </bean>

    <!-- 配置jdbc-->
    <bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate" p:dataSource-ref="dataSource"/>

    <!-- 配置事务-->
    <bean id="dataSourceTransactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>
    <tx:annotation-driven transaction-manager="dataSourceTransactionManager"/>
</beans>
```

⭐ **MyService** ：使用 jdbc 操作数据库，后面将对改代码进行修改并测试

```java
public class MyService {

    private JdbcTemplate jdbcTemplate;

    public void login() {
        System.out.println("登录！");
    }

    @Transactional(propagation = Propagation.REQUIRED)
    public void test1() {
        jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
        test2();
    }

    @Transactional(propagation = Propagation.NEVER)
    public void test2() {
        jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
    }

    public JdbcTemplate getJdbcTemplate() {
        return jdbcTemplate;
    }

    public void setJdbcTemplate(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }
}
```

## 2. 事务失效说明

### 2.1 事物失效的原因

1. 方法不是 public 的，@Transactional 只能用于 public 方法上，否则事务不会生效，如果要用在非 public 方法上，可以开启 AspectJ 代理模式
2. 数据库不支持事务
3. 没有被 Spring 管理
4. 异常被吃掉，事务不会回滚（或者抛出的异常没有被定义，默认为 RuntimeException）
5. 方法互相调用时注解失效，需要分析是普通方法还是代理方法的调用，只要代理对象调用其他方法时注解才会生效。

### 2.2 方法内调用事务失效

下面详细说明第 5 点：**方法互相调用时注解失效**

```java
@Transactional(propagation = Propagation.REQUIRED)
public void test1() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x1', 'xxx1', '10')");
    test2();
}

@Transactional(propagation = Propagation.NEVER)
public void test2() {
    jdbcTemplate.execute("insert into course (c_id, c_name, t_id) value ('x2', 'xxx2', '20')");
}
```

第一部分已经列出的代码，`test1()` 和 `test2()` 分别插入数据到数据库，其中 `test1()` 调用 `test2()`，那么此时会出现什么问题？

> 事务传播机制：
>
> - propagation_required：如果外部没有事务，就开启一个事务；如果外部存在一个事务，就加入到该事务中。
> - propagation_never：如果外部事务不存在，则不使用事务；如果外部存在一个事务，则抛出异常。

错误理解：因为 `test2()` 的事务传播机制为 never，所以 `test1()` 调用 `test2()`时， `test2()` 会抛出异常。

## 事物传播说明

|              | 里面异常，外面不捕获 | 里面异常，外面捕获   | 外面异常             |
| ------------ | -------------------- | -------------------- | -------------------- |
| required     | 都回滚               | 都回滚               | 都回滚               |
| requires_new | 都回滚               | 外面不回滚，里面回滚 | 外面回滚，里面不回滚 |
| nested       | 都回滚               | 外面不回滚，里面回滚 | 都回滚               |

requires_new：两个独立的事物

nested：里面的事物嵌套在外面