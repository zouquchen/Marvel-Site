---
title: ThreadLocal深度理解
date: 2022-07-13 16:28:42
permalink: /pages/14b9ec/
categories:
  - Java
  - Java并发编程
tags:
  - Java
  - JUC
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
# ThreadLocal深度理解

编写中...

## ThreadLocal简介

通常情况下，我们创建的变量可以被任何一个线程访问并修改的。如果想实现每一个线程都自己的专属本地变量可以使用 ThreadLocal类，ThreadLocal 类主要解决的是让每个线程绑定自己的值，可以将 ThreadLocal 类形象的比喻成存放数据的盒子，盒子中可存储每个线程的私有数据。

如果创建了一个 ThreadLocal 变量，那么访问这个变量的线程都会有这个变量的本地副本。他们可以使用`get()`和`set()`方法来获取默认值或将其值更改为当前线程所存放的副本的值，避免线程安全问题。

⭐ **ThreadLocal示例**

```java
public class ThreadLocalTest {
    public static ThreadLocal<String> holder = new ThreadLocal<>();

    public static void main(String[] args) throws InterruptedException {
        // 创建A线程并启动，，并且获取holder的值
        new Thread(() -> {
            holder.set("123"); // 在线程A中设置holder的值为123
            System.out.println(Thread.currentThread().getName() + ": " + holder.get()); // 获取holder的值
        }, "A").start();

        Thread.sleep(100);
        
        // 主线程
        System.out.println(Thread.currentThread().getName() + ": " + holder.get());  // 获取holder的值
    }
}
```

⭐ **控制台输出**

```output
A: 123
main: null
```

对于 A 线程，holder的值为 123；对于 main 线程，holder 的值为空，因为我们从未对其赋值。

## ThreadLocal数据结构

`Thread `类有一个类型为 `ThreadLocal.ThreadLocalMap` 的实例变量 `threadLocals`，也就是说每个线程有一个自己的`ThreadLocalMap`。

每个线程在往`ThreadLocal`里放值的时候，都会往自己的`ThreadLocalMap`里存，读也是以`ThreadLocal`作为引用，在自己的`map`里找对应的`key`，从而实现了**线程隔离**。

`ThreadLocalMap`有点类似`HashMap`的结构，只是`HashMap`是由**数组+链表**实现的，而`ThreadLocalMap`中并没有**链表**结构。

我们还要注意`Entry`， 它的`key`是`ThreadLocal<?> k` ，继承自`WeakReference`， 也就是我们常说的弱引用类型。

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs/ThreadLocal1.png" alt="image-20220718165310963" style="zoom:50%;" />

## ThreadLocal中的弱引用



## ThreadLocal内存泄露问题？

ThreadLocalMap中使用的key为ThreadLocal的弱引用，而value是强引用。所以，如果ThreadLocal没有被外部引用的情况下，在垃圾回收的时候，key会被清理掉，而value不会被清理掉。这样一来，ThreadLocalMap中就会出现key为null的Entry。假如我们不做任何措施的话，value永远无法被GC回收，这时候就产生了内存泄漏。

ThreadLocalMap实现已经考虑了这种情况，在调用set、get、remove方法的时候，会清理掉key为null的记录。所以在使用ThreadLocal方法后，最好手动调用remove方法。

<img src="https://raw.githubusercontent.com/zouquchen/Images/main/imgs/threadlocal%E5%8E%9F%E7%90%86%E5%9B%BE.png" alt="image.png" style="zoom:67%;" />
