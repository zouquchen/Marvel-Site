---
title: JVM内存区域详解
date: 2022-07-13 18:29:52
permalink: /pages/6198af/
categories:
  - Java
  - Java虚拟机
tags:
  - 
author: 
  name: Marvel
  link: https://github.com/zouquchen
---
# JVM内存区域详解

## JVM框架

四大部分：

- 类加载器ClassLoader：负责加载字节码文件，只负责class文件的加载，至于是否可以运行，由执行引擎决定。
- 运行时数据区Runtime Data Area：虚拟机栈、堆、方法区、程序计数器、本地方法栈
- 执行引擎 Execution Engine
- 本地库接口Native Interface

![JVM框架](https://raw.githubusercontent.com/zouquchen/Images/main/imgs/JVM%E6%A1%86%E6%9E%B6.png)

## JVM内存区域（运行时数据区）

![JVM内存区域](https://raw.githubusercontent.com/zouquchen/Images/main/imgs/JVM%E5%86%85%E5%AD%98%E5%8C%BA%E5%9F%9F.png)

java8的内存区域，按照线程私有和共享进行区分的话。私有部分包含：程序计数器、虚拟机栈、本地方法栈；共享部分包含：堆、方法区（元数据区）。

- **程序计数器**：线程私有，用于记录当前线程下条指令的位置，不会因为线程的切换而忘记当前线程所执行到的位置；分支、循环、跳转、异常处理、线程恢复都需要程序计数器来完成。程序计数器占的空间非常小，并且不会出现OutOfMemeryError，他会随着线程创建而创建，线程的结束而结束。
- **虚拟机栈**：线程私有，由一个个栈帧组成，每一个栈帧对应一个方法，每一个方法的调用到执行完成对应着栈帧的入栈和出栈，每个栈帧都包含局部变量表、操作数栈、动态链接、方法返回地址。会出现StackOverFlowError和OutOfMemeryError两种错误。
  - 局部变量表：主要存放了编译期可知的各种数据类型、对象引用
  - 动态链接：指向常量池中该栈帧所属方法的引用；
  - 操作数栈：主要作为方法调用的中转站使用，用于存放方法执行过程中产生的中间计算结果。另外，计算过程中产生的临时变量也会放在操作数栈中。
  - 方法返回地址：返回方法被调用的位置。
- **本地方法栈**：线程私有，虚拟机栈执行的是Java方法，本地方法栈则使用虚拟机的Native方法。本地方法被执行的时候，在本地方法栈也会创建一个栈帧，用于存放本地方法的局部变量表、操作数栈、动态链接、出口信息。也会出现StackOverFlowError和OutOfMemoryError两种错误。
- **堆**：线程共享，存放对象实例，几乎所有对象实例以及数组都在这里分配内存。堆主要分为两部分：新生代（Eden、Survivor）和老生代（Old），分为两部分有利于垃圾回收，因为垃圾回收的主要区域就是堆。
  - 字符串常量池也在堆中（JDK1.8）。
- **方法区**：用于存储被虚拟机加载的类信息、常量、静态变量、即时编译器编译后的代码等数据。
  - 在元空间内，直接使用内存，内存受系统的限制。
  - 以前是与堆地址相连，叫方法区，实现方式是永久代

## 本地方法栈有什么用？

本地方法栈与虚拟机栈所发挥的作用非常相似，区别只是虚拟机栈为虚拟机执行Java方法服务，而本地方法栈则是为了虚拟机使用本地方法服务。

## 没有程序计数器会怎么样？

Java程序中的流程控制无法得到正确的控制，多线程也无法正确的轮换。

## 类存放在哪里？

方法区，用于存储已被虚拟机加载的类型信息、常量、静态变量、即时编译器编译后的代码缓存等数据。

## 局部变量存放在哪里？

虚拟机栈，线程私有的，它的生命周期与线程相同。虚拟机栈描述的是Java方法执行的线程内存模型：每个方法被执行的时候，Java虚拟机都会同步创建一个栈帧用于存储局部变量表、操作数栈、动态链接、方法出口等信息。每一个方法被调用直至执行完毕的过程，就对应着一个栈帧在虚拟机中从入栈到出栈的过程。

局部变量表存放了编译期可知的各种Java虚拟机基本数据、对象引用和returnAddress类型。

## 方法区和运行时常量池溢出？

运行时常量池是方法区的一部分。

String::intern()是一个本地方法，它的作用是如果字符串常量池中已经包含一个等于此String对象的字符串，则返回代表池中整个字符串的String对象的引用；否则，会将此String对象包含的字符串添加到常量池，并且返回此String对象的引用。