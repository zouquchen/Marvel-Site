(window.webpackJsonp=window.webpackJsonp||[]).push([[37],{361:function(s,a,t){"use strict";t.r(a);var e=t(3),r=Object(e.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"java对象头与monitor监视器"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#java对象头与monitor监视器"}},[s._v("#")]),s._v(" Java对象头与Monitor监视器")]),s._v(" "),a("h2",{attrs:{id:"java对象头"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#java对象头"}},[s._v("#")]),s._v(" Java对象头")]),s._v(" "),a("p",[s._v("普通对象的对象头")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("|--------------------------------------------------------------|\n|                     Object Header (64 bits)                  |\n|------------------------------------|-------------------------|\n|        Mark Word (32 bits)         |   Klass Word (32 bits)  |\n|------------------------------------|-------------------------|\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("p",[s._v("数组对象的对象头")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("|---------------------------------------------------------------------------------|\n|                                 Object Header (96 bits)                         |\n|--------------------------------|-----------------------|------------------------|\n|        Mark Word(32bits)       |   Klass Word(32bits)  |  array length(32bits)  |\n|--------------------------------|-----------------------|------------------------|\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])]),a("h3",{attrs:{id:"mark-word"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#mark-word"}},[s._v("#")]),s._v(" Mark Word")]),s._v(" "),a("p",[s._v("这部分用来存储对象自身的运行时数据，如hashcode、gc分代年龄。")]),s._v(" "),a("blockquote",[a("p",[a("code",[s._v("Mark word")]),s._v("的位长度为JVM的一个Word大小，也就是说32位JVM的"),a("code",[s._v("Mark word")]),s._v("为32位，64位JVM的"),a("code",[s._v("Mark word")]),s._v("为64位。")])]),s._v(" "),a("p",[s._v("32位对象头")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("|-------------------------------------------------------|--------------------|\n|                  Mark Word (32 bits)                  |       State        |\n|-------------------------------------------------------|--------------------|\n| identity_hashcode:25 | age:4 | biased_lock:1 | lock:2 |       Normal       |\n|-------------------------------------------------------|--------------------|\n|  thread:23 | epoch:2 | age:4 | biased_lock:1 | lock:2 |       Biased       |\n|-------------------------------------------------------|--------------------|\n|               ptr_to_lock_record:30          | lock:2 | Lightweight Locked |\n|-------------------------------------------------------|--------------------|\n|               ptr_to_heavyweight_monitor:30  | lock:2 | Heavyweight Locked |\n|-------------------------------------------------------|--------------------|\n|                                              | lock:2 |    Marked for GC   |\n|-------------------------------------------------------|--------------------|\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[s._v("64位对象头")]),s._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("|------------------------------------------------------------------------------|--------------------|\n|                                  Mark Word (64 bits)                         |       State        |\n|------------------------------------------------------------------------------|--------------------|\n| unused:25 | identity_hashcode:31 | unused:1 | age:4 | biased_lock:1 | lock:2 |       Normal       |\n|------------------------------------------------------------------------------|--------------------|\n| thread:54 |       epoch:2        | unused:1 | age:4 | biased_lock:1 | lock:2 |       Biased       |\n|------------------------------------------------------------------------------|--------------------|\n|                       ptr_to_lock_record:62                         | lock:2 | Lightweight Locked |\n|------------------------------------------------------------------------------|--------------------|\n|                     ptr_to_heavyweight_monitor:62                   | lock:2 | Heavyweight Locked |\n|------------------------------------------------------------------------------|--------------------|\n|                                                                     | lock:2 |    Marked for GC   |\n|------------------------------------------------------------------------------|--------------------|\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br")])]),a("p",[a("strong",[s._v("各部分含义")])]),s._v(" "),a("ul",[a("li",[s._v("lock：2位的锁状态标记位，由于希望用尽可能少的二进制位表示尽可能多的信息，所以设置了lock标记。该标记的值不同，整个mark word表示的含义不同。")])]),s._v(" "),a("table",[a("thead",[a("tr",[a("th",[s._v("biased_lock")]),s._v(" "),a("th",[s._v("lock")]),s._v(" "),a("th",[s._v("状态")])])]),s._v(" "),a("tbody",[a("tr",[a("td",[s._v("0")]),s._v(" "),a("td",[s._v("01")]),s._v(" "),a("td",[s._v("无锁")])]),s._v(" "),a("tr",[a("td",[s._v("1")]),s._v(" "),a("td",[s._v("01")]),s._v(" "),a("td",[s._v("偏向锁")])]),s._v(" "),a("tr",[a("td",[s._v("0")]),s._v(" "),a("td",[s._v("00")]),s._v(" "),a("td",[s._v("轻量级锁")])]),s._v(" "),a("tr",[a("td",[s._v("0")]),s._v(" "),a("td",[s._v("10")]),s._v(" "),a("td",[s._v("重量级锁")])]),s._v(" "),a("tr",[a("td",[s._v("0")]),s._v(" "),a("td",[s._v("11")]),s._v(" "),a("td",[s._v("GC标准")])])])]),s._v(" "),a("ul",[a("li",[s._v("biased_lock：对象是否启用偏向锁标记，只占1个二进制位。为1时表示对象启用偏向锁，为0时表示对象没有偏向锁。")]),s._v(" "),a("li",[s._v("age：4位的Java对象年龄。在GC中，如果对象在Survivor区复制一次，年龄增加1。当对象达到设定的阈值时，将会晋升到老年代。默认情况下，并行GC的年龄阈值为15，并发GC的年龄阈值为6。由于age只有4位，所以最大值为15，这就是"),a("code",[s._v("-XX:MaxTenuringThreshold")]),s._v("选项最大值为15的原因。")]),s._v(" "),a("li",[s._v("identity_hashcode：25位的对象标识Hash码，采用延迟加载技术。调用方法"),a("code",[s._v("System.identityHashCode()")]),s._v("计算，并会将结果写到该对象头中。当对象被锁定时，该值会移动到管程Monitor中。")]),s._v(" "),a("li",[s._v("thread：持有偏向锁的线程ID。")]),s._v(" "),a("li",[s._v("epoch：偏向时间戳。")]),s._v(" "),a("li",[s._v("ptr_to_lock_record：指向栈中锁记录的指针。")]),s._v(" "),a("li",[s._v("ptr_to_heavyweight_monitor：指向管程Monitor的指针。")])]),s._v(" "),a("h3",{attrs:{id:"class-pointer"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#class-pointer"}},[s._v("#")]),s._v(" class pointer")]),s._v(" "),a("p",[s._v("这一部分用于存储对象的类型指针，该指针指向它的类元数据，JVM通过这个指针确定对象是哪个类的实例。该指针的位长度为JVM的一个字大小，即32位的JVM为32位，64位的JVM为64位。")]),s._v(" "),a("p",[s._v("如果应用的对象过多，使用64位的指针将浪费大量内存，统计而言，64位的JVM将会比32位的JVM多耗费50%的内存。为了节约内存可以使用选项"),a("code",[s._v("+UseCompressedOops")]),s._v("开启指针压缩，其中，oop即ordinary object pointer普通对象指针。开启该选项后，下列指针将压缩至32位：")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("每个Class的属性指针（即静态变量）")])]),s._v(" "),a("li",[a("p",[s._v("每个对象的属性指针（即对象变量）")])]),s._v(" "),a("li",[a("p",[s._v("普通对象数组的每个元素指针")])])]),s._v(" "),a("p",[s._v("当然，也不是所有的指针都会压缩，一些特殊类型的指针JVM不会优化，比如指向PermGen的Class对象指针(JDK8中指向元空间的Class对象指针)、本地变量、堆栈元素、入参、返回值和NULL指针等。")]),s._v(" "),a("h3",{attrs:{id:"array-length"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#array-length"}},[s._v("#")]),s._v(" array length")]),s._v(" "),a("p",[s._v("如果对象是一个数组，那么对象头还需要有额外的空间用于存储数组的长度，这部分数据的长度也随着JVM架构的不同而不同：32位的JVM上，长度为32位；64位JVM则为64位。64位JVM如果开启"),a("code",[s._v("+UseCompressedOops")]),s._v("选项，该区域长度也将由64位压缩至32位。")]),s._v(" "),a("h2",{attrs:{id:"monitor"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#monitor"}},[s._v("#")]),s._v(" Monitor")]),s._v(" "),a("p",[s._v("Monitor被翻译为"),a("strong",[s._v("监视器")]),s._v("或"),a("strong",[s._v("管程")])]),s._v(" "),a("p",[s._v("每个Java对象都可以关联一个Monitor对象，如果使用synchronized给对象上锁（重量级锁）之后，该对象头的Mark Word中就被设置指向Monitor对象的指针")]),s._v(" "),a("p",[s._v("Monitor结构如下")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://raw.githubusercontent.com/zouquchen/Images/main/imgs/monitor.png",alt:"image-20220715202827649"}})])])}),[],!1,null,null,null);a.default=r.exports}}]);